name: CI Build and Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  pull-requests: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build (capture log)
        id: build_step
        shell: bash
        run: |
          set -o pipefail
          make all 2>&1 | tee build.log

      - name: Extract brief summary
        if: always()
        shell: bash
        run: |
          if [[ -f build.log ]]; then
            { 
              grep -niE '(^| )error:|^FAIL|^ERROR|make(:\[*[0-9]+\]*)?: \*\*\*|collect2: error|ld returned [0-9]+' build.log | head -n 10 \
              || true
            } > summary.txt
            if [[ ! -s summary.txt ]]; then
              echo "Tail of build.log:" > summary.txt
              tail -n 80 build.log >> summary.txt
            fi
          else
            echo "No build.log found." > summary.txt
          fi

      - name: Comment on PR (status + summary)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}'; // success | failure | cancelled
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const read = p => { try { return fs.readFileSync(p, 'utf8').trim(); } catch { return ''; } };
            const summary = read('summary.txt');
            const logTail = read('build.log').split('\n').slice(-80).join('\n');

            const fence = '```';
            let body;
            if (status === 'success') {
              body = `✅ **Build Succeeded**\n\n[View run logs](${runUrl})`;
            } else {
              body = [
                '❌ **Build Failed**',
                '',
                '**Build Log (Summary):**',
                fence, (summary || '(no summary)'), fence,
                '',
                '[View full log](' + runUrl + ')'
              ].join('\n');
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
